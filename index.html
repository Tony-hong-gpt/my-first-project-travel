<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ì—¬í–‰ ë¦¬ë·° ë¶„ì„ ì‹¤í—˜ v2</title>
  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --border-subtle: #e5e7eb;
      --text-main: #111827;
      --text-sub: #6b7280;
      --green: #16a34a;
      --red: #dc2626;
      --accent: #3b82f6;
    }
    /* CSSì— í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
    mark.hl {
      background: #fde68a;
      padding: 0 2px;
      border-radius: 4px;
}

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: radial-gradient(circle at top, #e0f2fe 0, #f3f4f6 40%, #eef2ff 100%);
      color: var(--text-main);
    }

    .app {
      max-width: 960px;
      margin: 0 auto;
      padding: 32px 20px 48px;
    }

    h1 {
      margin: 0 0 12px;
      font-size: 1.8rem;
      letter-spacing: -0.03em;
    }

    .subtitle {
      margin: 0 0 20px;
      font-size: 0.95rem;
      color: var(--text-sub);
    }

    textarea {
      width: 100%;
      min-height: 140px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      font-size: 0.95rem;
      resize: vertical;
      outline: none;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.06);
      background: rgba(255, 255, 255, 0.9);
    }
    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      align-items: center;
    }

    button {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.08s ease,
        background-color 0.12s ease, border-color 0.12s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.3);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(37, 99, 235, 0.35);
    }

    .btn-secondary {
      background: #ffffff;
      color: var(--text-main);
      border-color: var(--border-subtle);
    }
    .btn-secondary:hover {
      background: #f9fafb;
      border-color: #d1d5db;
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.06);
    }

    select {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 8px 12px;
      font-size: 0.9rem;
      background: #fff;
      outline: none;
    }

    h2 {
      margin-top: 28px;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .summary-bar {
      font-size: 0.9rem;
      color: var(--text-sub);
      margin-bottom: 12px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 14px 18px 16px;
      margin-bottom: 14px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 14px 35px rgba(15, 23, 42, 0.08);
      backdrop-filter: blur(10px);
    }

    .card--good {
      background: linear-gradient(135deg, #ecfdf3, #f0fdf4);
      border-color: rgba(22, 163, 74, 0.35);
    }
    .card--bad {
      background: linear-gradient(135deg, #fef2f2, #fff);
      border-color: rgba(220, 38, 38, 0.28);
    }
    .card--neutral {
      background: linear-gradient(135deg, #f9fafb, #ffffff);
      border-color: rgba(148, 163, 184, 0.3);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-sub);
    }

    .card-header-right{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .score-pill {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 800;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .score-pill--good { background: rgba(22, 163, 74, 0.10); color: var(--green); }
    .score-pill--bad { background: rgba(220, 38, 38, 0.10); color: var(--red); }
    .score-pill--neutral { background: rgba(107, 114, 128, 0.10); color: #374151; }

    .cred-pill{
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.82rem;
      font-weight: 800;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      border: 1px solid transparent;
    }
    .cred--high{ background: rgba(22,163,74,0.10); color: #15803d; border-color: rgba(22,163,74,0.25); }
    .cred--mid { background: rgba(245,158,11,0.12); color: #92400e; border-color: rgba(245,158,11,0.30); }
    .cred--low { background: rgba(220,38,38,0.10); color: #b91c1c; border-color: rgba(220,38,38,0.25); }

    .review-text {
      font-size: 0.95rem;
      line-height: 1.5;
      margin-top: 4px;
      margin-bottom: 8px;
    }

    .meta-row {
      font-size: 0.8rem;
      color: var(--text-sub);
      margin-bottom: 6px;
    }
    .meta-row strong {
      margin-right: 4px;
      color: #4b5563;
    }

    .tag-group { font-size: 0.8rem; margin-top: 4px; }
    .tag-group-label { font-weight: 700; margin-right: 6px; color: #4b5563; }

    .chip-empty { font-size: 0.8rem; color: #9ca3af; }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      margin: 2px 6px 0 0;
      border-radius: 999px;
      font-size: 0.78rem;
      font-weight: 700;
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .card-summary {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px dashed rgba(148, 163, 184, 0.7);
      font-size: 0.85rem;
      color: var(--text-sub);
    }

        /* ===== Dashboard (Step 3-D) ===== */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin: 12px 0 14px;
    }
    
    .dash-card {
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.06);
    }
    
    .dash-label {
      font-size: 0.82rem;
      color: var(--text-sub);
      font-weight: 700;
    }
    
    .dash-value {
      margin-top: 6px;
      font-size: 1.25rem;
      font-weight: 900;
      letter-spacing: -0.02em;
    }
    
    .dash-sub {
      margin-top: 4px;
      font-size: 0.8rem;
      color: var(--text-sub);
    }
    
    .dash-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 12px;
    }
    
    .panel {
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.06);
    }
    
    .panel-title {
      font-size: 0.9rem;
      font-weight: 900;
      margin-bottom: 8px;
    }
    
    .bar {
      width: 100%;
      height: 10px;
      background: rgba(148, 163, 184, 0.18);
      border-radius: 999px;
      overflow: hidden;
      margin-top: 6px;
    }
    
    .bar > span {
      display: block;
      height: 100%;
      width: 0%;
      background: rgba(59, 130, 246, 0.55);
    }
    
    .barline {
      margin: 8px 0 10px;
      font-size: 0.82rem;
      color: var(--text-sub);
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    
    .topwords {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    
    @media (max-width: 760px) {
      .dashboard { grid-template-columns: 1fr; }
      .dash-row { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="app">
    <h1>ì—¬í–‰ ë¦¬ë·° ë¶„ì„ ì‹¤í—˜ v2</h1>
    <p class="subtitle">
      ì—¬ëŸ¬ ê°œì˜ ì—¬í–‰ ë¦¬ë·°ë¥¼ ì¤„ë°”ê¿ˆìœ¼ë¡œ ë‚˜ëˆ ì„œ ì…ë ¥í•´ë³´ì„¸ìš”. (Day2: ì‹ ë¢°ë„ + ì •ë ¬ + í•„í„° + ì €ì¥)
    </p>

    <p style="font-size: 0.9rem; color: #6b7280;">
      ì˜ˆì‹œ)<br />
      ìœ„ì¹˜ë„ ì¢‹ê³  ì§ì›ë“¤ì´ ì •ë§ ì¹œì ˆí–ˆì–´ìš”.<br />
      ë°©ì€ ê¹¨ë—í–ˆì§€ë§Œ ì†ŒìŒì´ ë„ˆë¬´ ì‹¬í–ˆìŠµë‹ˆë‹¤.
    </p>

    <textarea id="reviews"></textarea>

    <div class="controls">
      <button type="button" class="btn-secondary" onclick="fillSample()">ìƒ˜í”Œ ë¦¬ë·° ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button type="button" class="btn-primary" onclick="analyzeAll()">ëª¨ë‘ ë¶„ì„í•˜ê¸°</button>

      <select id="sortMode" onchange="onUiChange()">
        <option value="score_desc">ì ìˆ˜ ë†’ì€ ìˆœ</option>
        <option value="score_asc">ì ìˆ˜ ë‚®ì€ ìˆœ</option>
        <option value="cred_desc">ì‹ ë¢°ë„ ë†’ì€ ìˆœ</option>
        <option value="cred_asc">ì‹ ë¢°ë„ ë‚®ì€ ìˆœ</option>
        <option value="len_desc">ê¸€ììˆ˜ ê¸´ ìˆœ</option>
        <option value="len_asc">ê¸€ììˆ˜ ì§§ì€ ìˆœ</option>
      </select>
      <input id="searchQuery" placeholder="ê²€ìƒ‰: ì˜ˆ) ìœ„ì¹˜, ì†ŒìŒ, ì¹œì ˆ"
             oninput="onUiChange()"
             style="padding:8px 12px; border-radius:999px; border:1px solid var(--border-subtle); font-size:0.9rem; outline:none; min-width:240px;">

      <select id="filterMode" onchange="onUiChange()">
        <option value="all">ì „ì²´</option>
        <option value="pos_only">ê¸ì •ë§Œ</option>
        <option value="neg_only">ë¶€ì •ë§Œ</option>
        <option value="cred_low">ì‹ ë¢°ë„ ë‚®ìŒ(55 ë¯¸ë§Œ)</option>
      </select>
    </div>

    <h2>ê²°ê³¼:</h2>
    <div id="output"></div>
  </div>

  <script>
    let lastResults = [];
    let lastStats = null;

    const STORAGE_KEY = "travelReviewUI_v2";

    function saveUiState() {
        const sortMode = document.getElementById("sortMode")?.value || "score_desc";
        const filterMode = document.getElementById("filterMode")?.value || "all";
        const searchQuery = document.getElementById("searchQuery")?.value || "";
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ sortMode, filterMode, searchQuery }));
      }

    function loadUiState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const { sortMode, filterMode, searchQuery } = JSON.parse(raw);
    
        const s = document.getElementById("sortMode");
        const f = document.getElementById("filterMode");
        const q = document.getElementById("searchQuery");
    
        if (s && sortMode) s.value = sortMode;
        if (f && filterMode) f.value = filterMode;
        if (q && typeof searchQuery === "string") q.value = searchQuery;
      } catch (e) {}
    }

    function onUiChange() {
      saveUiState();
      renderResults();
    }

    function scoreReview(text) {
      text = text.replace(/\s+/g, " ").trim();
      let score = 50;

      if (text.includes("ì¢‹")) score += 10;
      if (text.includes("ì¶”ì²œ")) score += 10;
      if (text.includes("ë§Œì¡±")) score += 10;
      if (text.includes("ìµœê³ ")) score += 5;
      if (text.includes("ì™„ë²½")) score += 5;
      if (text.includes("ì¹œì ˆ")) score += 10;
      if (text.includes("ê¸°ì¨")) score += 10;
      if (text.includes("ê¸°ë¶„")) score += 10;

      if (text.includes("ë³„ë¡œ")) score -= 20;
      if (text.includes("ì‹¤ë§")) score -= 20;
      if (text.includes("ìµœì•…")) score -= 20;
      if (text.includes("ë¹„ìŒŒ")) score -= 10;
      if (text.includes("ë¶ˆí¸")) score -= 10;
      if (text.includes("ì‹œë„ëŸ½")) score -= 10;
      if (text.includes("ì†ŒìŒ")) score -= 10;

      return Math.max(0, Math.min(100, score));
    }

    function extractKeywords(text) {
      const positive = ["ì¢‹", "ë§Œì¡±", "í¸ì•ˆ", "ì¹œì ˆ", "ìµœê³ ", "ê¸°ë¶„"];
      const negative = ["ë³„ë¡œ", "ë¶ˆí¸", "ì‹¤ë§", "ë¹„ìŒŒ", "ì†ŒìŒ", "ì‹œë„ëŸ½", "ì¢", "ë”ëŸ½"];
      const facility = ["ë°©", "ë£¸", "í™”ì¥ì‹¤", "ì¹¨ëŒ€", "ì²­ì†Œ", "ì‹œì„¤", "ìš•ì‹¤"];
      const service = ["ì§ì›", "ì‘ëŒ€", "ì„œë¹„ìŠ¤", "ì¹œì ˆ"];
      const location = ["ìœ„ì¹˜", "êµí†µ", "ì—­", "ê·¼ì²˜", "ê´€ê´‘ì§€", "ì´ë™", "ë„ë³´", "ì ‘ê·¼", "ë™ì„ "];
      const price = ["ê°€ê²©", "ê°€ì„±ë¹„", "ë¹„ì‹¸", "ì €ë ´"];

      const find = (words) => words.filter(w => text.includes(w));

      return {
        positive: find(positive),
        negative: find(negative),
        facility: find(facility),
        service: find(service),
        location: find(location),
        price: find(price),
      };
    }

    function credibilityScore(text) {
      let score = 50;

      if (text.length < 10) score -= 20;
      if (text.length > 80) score += 10;

      const detailWords = ["ê°€ê²©", "ìœ„ì¹˜", "ì†ŒìŒ", "ì¹¨ëŒ€", "ì²­ì†Œ", "ì„œë¹„ìŠ¤", "ì§ì›", "ì£¼ì°¨", "ì§€í•˜ì² "];
      if (detailWords.some(w => text.includes(w))) score += 10;

      if (/\d/.test(text)) score += 10;

      const hypeWords = ["ì •ë§", "ì™„ì „", "ìµœê³ ", "ìµœì•…", "ì§„ì§œ", "ì—„ì²­"];
      const hypeCount = hypeWords.filter(w => text.includes(w)).length;
      if (hypeCount >= 2) score -= 15;

      const charSet = new Set(text.split(""));
      if (charSet.size < text.length / 2.5) score -= 10;

      return Math.max(0, Math.min(100, score));
    }

    function credibilityLabel(c) {
      if (c >= 80) return "ë†’ìŒ";
      if (c >= 55) return "ë³´í†µ";
      return "ë‚®ìŒ";
    }
    function credibilityClass(c) {
      if (c >= 80) return "cred--high";
      if (c >= 55) return "cred--mid";
      return "cred--low";
    }

    function scoreEmoji(score) {
      if (score >= 80) return "ğŸ˜Š";
      if (score <= 40) return "ğŸ˜Ÿ";
      return "ğŸ˜";
    }

    function summarizeReview(kw, score, cred) {
      const posCount = kw.positive.length;
      const negCount = kw.negative.length;

      let toneLabel = "";
      if (posCount > 0 && negCount === 0) {
        if (score >= 85) toneLabel = "ë§¤ìš° ë§Œì¡±ë„ê°€ ë†’ì€ í›„ê¸°ì…ë‹ˆë‹¤.";
        else if (score >= 70) toneLabel = "ëŒ€ì²´ë¡œ ë§Œì¡±ìŠ¤ëŸ¬ìš´ í›„ê¸°ì…ë‹ˆë‹¤.";
        else toneLabel = "ê¸ì •ì ì´ì§€ë§Œ ì ìˆ˜ëŠ” ë³´ìˆ˜ì ìœ¼ë¡œ ê³„ì‚°ëœ í›„ê¸°ì…ë‹ˆë‹¤.";
      } else if (negCount > 0 && posCount === 0) {
        if (score <= 40) toneLabel = "ë¶ˆë§Œì´ ê°•í•˜ê²Œ ë“œëŸ¬ë‚˜ëŠ” í›„ê¸°ì…ë‹ˆë‹¤.";
        else toneLabel = "ì „ë°˜ì ìœ¼ë¡œ ì•„ì‰¬ìš´ ì ì´ ê°•ì¡°ëœ í›„ê¸°ì…ë‹ˆë‹¤.";
      } else if (posCount === 0 && negCount === 0) {
        toneLabel = "ê°ì • í‘œí˜„ì´ í¬ì§€ ì•Šì€ ì¤‘ë¦½ì ì¸ í›„ê¸°ì…ë‹ˆë‹¤.";
      } else {
        toneLabel = "ì¢‹ì€ ì ê³¼ ì•„ì‰¬ìš´ ì ì´ í•¨ê»˜ ì„ì—¬ ìˆëŠ” í›„ê¸°ì…ë‹ˆë‹¤.";
      }

      const aspects = [];
      if (kw.location.length > 0) aspects.push("ìœ„ì¹˜/ì´ë™");
      if (kw.service.length > 0) aspects.push("ì„œë¹„ìŠ¤");
      if (kw.facility.length > 0) aspects.push("ì‹œì„¤");
      if (kw.price.length > 0) aspects.push("ê°€ê²©");

      let aspectSentence = "";
      if (aspects.length === 1) aspectSentence = `${aspects[0]}ì— ëŒ€í•œ í‰ê°€ê°€ ì¤‘ì‹¬ì…ë‹ˆë‹¤.`;
      else if (aspects.length > 1) aspectSentence = `${aspects.join(", ")} ë“± ì—¬ëŸ¬ ìš”ì†Œë¥¼ í•¨ê»˜ í‰ê°€í•˜ê³  ìˆìŠµë‹ˆë‹¤.`;

      let credSentence = "";
      if (cred >= 80) credSentence = "êµ¬ì²´ì ì¸ ì •ë³´ê°€ ë§ì•„ ë¹„êµì  ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë¦¬ë·°ë¡œ ë³´ì…ë‹ˆë‹¤.";
      else if (cred >= 60) credSentence = "ì „ì²´ì ìœ¼ë¡œ ì°¸ê³ í•  ë§Œí•˜ì§€ë§Œ, ì„¸ë¶€ ì •ë³´ëŠ” ì¼ë¶€ ë¶€ì¡±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
      else credSentence = "í‘œí˜„ì´ ë‹¤ì†Œ ì¶”ìƒì ì´ì–´ì„œ ì‹ ë¢°ë„ëŠ” ë‚®ì€ í¸ì…ë‹ˆë‹¤.";

      return [toneLabel, aspectSentence, credSentence].filter(Boolean).join(" ");
    }

    function renderTags(words, bgColor) {
      if (!words || words.length === 0) return '<span class="chip-empty">ì—†ìŒ</span>';
      return words.map(w => `<span class="chip" style="background:${bgColor}; border-color:transparent;">${w}</span>`).join("");
    }

    function fillSample() {
      const sampleLines = [
        "ìœ„ì¹˜ë„ ì¢‹ê³  ì§ì›ë“¤ì´ ì •ë§ ì¹œì ˆí•´ì„œ ë‹¤ì‹œ ì˜¤ê³  ì‹¶ì€ ê³³ì…ë‹ˆë‹¤. ì •ë§ ë§Œì¡±í•©ë‹ˆë‹¤.",
        "ë°©ì€ ê¹¨ë—í–ˆì§€ë§Œ ì†ŒìŒì´ ì¡°ê¸ˆ ì•„ì‰¬ì› ì–´ìš”.",
        "ê°€ê²©ì€ ì¡°ê¸ˆ ë¹„ìŒŒì§€ë§Œ ì„œë¹„ìŠ¤ì™€ ìœ„ì¹˜ëŠ” ë§¤ìš° ë§Œì¡±ìŠ¤ëŸ¬ì› ìŠµë‹ˆë‹¤.",
        "ì£¼ë³€ ê´€ê´‘ì§€ê°€ ë§ì•„ì„œ ì´ë™í•˜ê¸° í¸í–ˆìŠµë‹ˆë‹¤.",
        "ì§ì› ì‘ëŒ€ê°€ ì¹œì ˆí–ˆê³  ì²´í¬ì¸ ê³¼ì •ë„ í¸ì•ˆí–ˆìŠµë‹ˆë‹¤.",
      ];
      document.getElementById("reviews").value = sampleLines.join("\n");
    }

    function analyzeAll() {
      const raw = document.getElementById("reviews").value.trim();
      const lines = raw.split(/\n+/).map(l => l.trim()).filter(Boolean);

      if (lines.length === 0) {
        document.getElementById("output").innerHTML = "<p>ë¦¬ë·°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>";
        lastResults = [];
        lastStats = null;
        return;
      }

      lastResults = [];
      let totalScore = 0;
      let totalLength = 0;
      let totalCred = 0;

      lines.forEach((review, idx) => {
        const score = scoreReview(review);
        const cred = credibilityScore(review);
        const kw = extractKeywords(review);
        const length = review.length;
        const summary = summarizeReview(kw, score, cred);

        totalScore += score;
        totalLength += length;
        totalCred += cred;

        lastResults.push({ idx: idx + 1, review, score, cred, length, kw, summary });
      });

      lastStats = {
        count: lines.length,
        avgScore: Math.round(totalScore / lines.length),
        avgLength: Math.round(totalLength / lines.length),
        avgCred: Math.round(totalCred / lines.length),
      };

      renderResults();
    }

    function applyFilter(items) {
      const mode = document.getElementById("filterMode")?.value || "all";

      if (mode === "pos_only") {
        return items.filter(x => x.kw.positive.length > 0 && x.kw.negative.length === 0);
      }
      if (mode === "neg_only") {
        return items.filter(x => x.kw.negative.length > 0 && x.kw.positive.length === 0);
      }
      if (mode === "cred_low") {
        return items.filter(x => x.cred < 55);
      }
      return items; // all
    }

  function normalize(s) {
      return (s || "").toString().trim().toLowerCase();
    }
    
    function applySearch(items) {
      const q = normalize(document.getElementById("searchQuery")?.value);
      if (!q) return items;
    
      return items.filter(x => {
        const hay = [
          x.review,
          x.summary,
          ...(x.kw.positive || []),
          ...(x.kw.negative || []),
          ...(x.kw.facility || []),
          ...(x.kw.service || []),
          ...(x.kw.location || []),
          ...(x.kw.price || []),
        ].join(" ").toLowerCase();
    
        return hay.includes(q);
      });
    }

    function escapeRegExp(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }
    
    function highlight(text) {
      const q = normalize(document.getElementById("searchQuery")?.value);
      if (!q) return text;
    
      const safe = escapeRegExp(q);
      const re = new RegExp(safe, "gi");
      return text.replace(re, (m) => `<mark class="hl">${m}</mark>`);
    }

    function clamp(n, min, max) {
      return Math.max(min, Math.min(max, n));
    }
    
    function computeTopKeywords(items, topN = 5) {
      const map = new Map();
    
      items.forEach(x => {
        const groups = [
          ...(x.kw.positive || []),
          ...(x.kw.negative || []),
          ...(x.kw.location || []),
          ...(x.kw.service || []),
          ...(x.kw.facility || []),
          ...(x.kw.price || []),
        ];
        groups.forEach(w => {
          map.set(w, (map.get(w) || 0) + 1);
        });
      });
    
      return [...map.entries()]
        .sort((a, b) => b[1] - a[1])
        .slice(0, topN); // [ [word, count], ... ]
    }
    
    function dist3(value, a, b) {
      // 3êµ¬ê°„ ë¶„í¬ (0~a-1 / a~b-1 / b~100)
      if (value < a) return 0;
      if (value < b) return 1;
      return 2;
    }
    
    function computeDistribution(items) {
      const scoreBins = [0, 0, 0]; // <50, 50~74, >=75
      const credBins  = [0, 0, 0]; // <55, 55~79, >=80
    
      items.forEach(x => {
        scoreBins[dist3(x.score, 50, 75)]++;
        credBins[dist3(x.cred, 55, 80)]++;
      });
    
      return { scoreBins, credBins };
    }
    
    function renderDashboard(view) {
      const top = computeTopKeywords(view, 5);
      const { scoreBins, credBins } = computeDistribution(view);
    
      const total = view.length || 1;
    
      const scorePct = scoreBins.map(v => Math.round((v / total) * 100));
      const credPct  = credBins.map(v => Math.round((v / total) * 100));
    
      const topHtml = top.length
        ? top.map(([w, c]) => `<span class="chip" style="background:#eef2ff;border-color:transparent;">${highlight(w)} Â· ${c}</span>`).join("")
        : `<span class="chip-empty">ì—†ìŒ</span>`;
    
      return `
        <div class="dashboard">
          <div class="dash-card">
            <div class="dash-label">í‰ê·  ì ìˆ˜</div>
            <div class="dash-value">${lastStats?.avgScore ?? "-"}</div>
            <div class="dash-sub">ì „ì²´ ì…ë ¥ ê¸°ì¤€</div>
          </div>
          <div class="dash-card">
            <div class="dash-label">í‰ê·  ì‹ ë¢°ë„</div>
            <div class="dash-value">${lastStats?.avgCred ?? "-"}</div>
            <div class="dash-sub">ì „ì²´ ì…ë ¥ ê¸°ì¤€</div>
          </div>
          <div class="dash-card">
            <div class="dash-label">í˜„ì¬ í‘œì‹œ ê°œìˆ˜</div>
            <div class="dash-value">${view.length}</div>
            <div class="dash-sub">í•„í„°/ê²€ìƒ‰ ì ìš© ê²°ê³¼</div>
          </div>
        </div>
    
        <div class="dash-row">
          <div class="panel">
            <div class="panel-title">TOP í‚¤ì›Œë“œ</div>
            <div class="topwords">${topHtml}</div>
          </div>
    
          <div class="panel">
            <div class="panel-title">ë¶„í¬ ìš”ì•½</div>
    
            <div class="barline">
              <span>ì ìˆ˜: 0~49 (${scoreBins[0]})</span><span>${scorePct[0]}%</span>
            </div>
            <div class="bar"><span style="width:${clamp(scorePct[0],0,100)}%"></span></div>
    
            <div class="barline">
              <span>ì ìˆ˜: 50~74 (${scoreBins[1]})</span><span>${scorePct[1]}%</span>
            </div>
            <div class="bar"><span style="width:${clamp(scorePct[1],0,100)}%"></span></div>
    
            <div class="barline">
              <span>ì ìˆ˜: 75~100 (${scoreBins[2]})</span><span>${scorePct[2]}%</span>
            </div>
            <div class="bar"><span style="width:${clamp(scorePct[2],0,100)}%"></span></div>
    
            <hr style="border:none;border-top:1px dashed rgba(148,163,184,0.6);margin:12px 0;">
    
            <div class="barline">
              <span>ì‹ ë¢°ë„: 0~54 (${credBins[0]})</span><span>${credPct[0]}%</span>
            </div>
            <div class="bar"><span style="width:${clamp(credPct[0],0,100)}%"></span></div>
    
            <div class="barline">
              <span>ì‹ ë¢°ë„: 55~79 (${credBins[1]})</span><span>${credPct[1]}%</span>
            </div>
            <div class="bar"><span style="width:${clamp(credPct[1],0,100)}%"></span></div>
    
            <div class="barline">
              <span>ì‹ ë¢°ë„: 80~100 (${credBins[2]})</span><span>${credPct[2]}%</span>
            </div>
            <div class="bar"><span style="width:${clamp(credPct[2],0,100)}%"></span></div>
          </div>
        </div>
      `;
    }
    
    function renderResults() {
      if (!lastResults || lastResults.length === 0 || !lastStats) return;
    
      const sortMode = document.getElementById("sortMode")?.value || "score_desc";
    
      let view = applyFilter([...lastResults]);
      view = applySearch(view);
    
      view.sort((a, b) => {
        switch (sortMode) {
          case "score_desc": return b.score - a.score;
          case "score_asc":  return a.score - b.score;
          case "cred_desc":  return b.cred - a.cred;
          case "cred_asc":   return a.cred - b.cred;
          case "len_desc":   return b.length - a.length;
          case "len_asc":    return a.length - b.length;
          default: return 0;
        }
      });
    
      let cardsHtml = "";
    
      view.forEach((item) => {
        const { review, score, cred, length, kw, summary, idx } = item;
    
        let moodClass = "card--neutral";
        let scoreClass = "score-pill--neutral";
        if (score >= 75) { moodClass = "card--good"; scoreClass = "score-pill--good"; }
        else if (score <= 50) { moodClass = "card--bad"; scoreClass = "score-pill--bad"; }
    
        cardsHtml += `
          <article class="card ${moodClass}">
            <header class="card-header">
              <div class="card-title">ë¦¬ë·° #${idx}</div>
    
              <div class="card-header-right">
                <div class="cred-pill ${credibilityClass(cred)}">
                  ${cred}ì  Â· ${credibilityLabel(cred)}
                </div>
                <div class="score-pill ${scoreClass}">
                  ${score}ì  ${scoreEmoji(score)}
                </div>
              </div>
            </header>
    
            <div class="review-text">${highlight(review)}</div>
            <div class="meta-row"><strong>ê¸€ììˆ˜</strong> ${length}ì</div>
    
            <div class="tag-group">
              <div><span class="tag-group-label">ê¸ì •</span>${renderTags(kw.positive, "#e6f4ea")}</div>
              <div><span class="tag-group-label">ë¶€ì •</span>${renderTags(kw.negative, "#fdecea")}</div>
              <div><span class="tag-group-label">ì‹œì„¤</span>${renderTags(kw.facility, "#e8f0fe")}</div>
              <div><span class="tag-group-label">ì„œë¹„ìŠ¤</span>${renderTags(kw.service, "#fff4e5")}</div>
              <div><span class="tag-group-label">ìœ„ì¹˜</span>${renderTags(kw.location, "#e0f7fa")}</div>
              <div><span class="tag-group-label">ê°€ê²©</span>${renderTags(kw.price, "#f3e5f5")}</div>
            </div>
    
            <div class="card-summary">${highlight(summary)}</div>
          </article>
        `;
      });
    
      const filterMode = document.getElementById("filterMode")?.value || "all";
      const filterText = {
        all: "ì „ì²´",
        pos_only: "ê¸ì •ë§Œ",
        neg_only: "ë¶€ì •ë§Œ",
        cred_low: "ì‹ ë¢°ë„ ë‚®ìŒ(55 ë¯¸ë§Œ)"
      }[filterMode];
    
      const dashboardHtml = renderDashboard(view);

      document.getElementById("output").innerHTML = `
        ${dashboardHtml}
        <div class="summary-bar">
          (í‘œì‹œ: <strong>${filterText}</strong>)
          ì´ ${lastStats.count}ê°œì˜ ë¦¬ë·°,
          í‰ê·  ì ìˆ˜: <strong>${lastStats.avgScore}ì </strong>,
          í‰ê·  ë¦¬ë·° ê¸¸ì´: <strong>${lastStats.avgLength}ê¸€ì</strong>,
          í‰ê·  ì‹ ë¢°ë„: <strong>${lastStats.avgCred}ì </strong>
          <br/>
          í˜„ì¬ í•„í„° ê²°ê³¼: <strong>${view.length}ê°œ</strong>
        </div>
        ${cardsHtml || "<p>í•„í„° ì¡°ê±´ì— ë§ëŠ” ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>"}
      `;
    }

    // í˜ì´ì§€ ë¡œë“œì‹œ ì •ë ¬/í•„í„° ë³µì›
    window.addEventListener("DOMContentLoaded", () => {
      loadUiState();
    });
  </script>
</body>
</html>
